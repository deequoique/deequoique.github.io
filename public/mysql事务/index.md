# MySQL事务

## ACID

- A:原子性（Atomicity）
    
- C：一致性（Consistency）
    
- I：隔离性（Isolation）
    
- D：持久性（Durability）
    

### 原子性

不必多说

undo log（回滚日志） 来保证

### 一致性

就是保证一些不合理的东西不会出现（一般在业务层处理）

比如高考考了1024分。。。。

### 持久性

每次操作的结果应该永久保留

通过 redo log （重做日志）来保证

### 隔离性

保证其他的状态转换不会影响到本次的状态转换

MVCC（多版本并发控制） 或锁机制来保证

## 事务的几个状态

<img src="/image/3.1.png" width = 100%>

## 脏读、幻读、不可重复读

<img src="/image/3.2.png" width = 60%>

### 脏读

1、在事务A执行过程中，事务A对数据资源进行了修改，事务B读取了事务A修改后的数据。

2、由于某些原因，事务A并没有完成提交，发生了RollBack操作，则事务B读取的数据就是脏数据

### 不可重复读

事务B读取了两次数据资源，在这两次读取的过程中事务A修改了数据，导致事务B在这两次读取出来的数据不一致。

这种在同一个事务中，前后两次读取的数据不一致的现象就是不可重复读(Nonrepeatable Read)

### 幻读

事务B前后两次读取同一个范围的数据，在事务B两次读取的过程中事务A新增了数据，导致事务B后一次读取到前一次查询没有看到的行

### 不可重复读和幻读的区别

幻读和不可重复读有些类似，但是幻读强调的是集合的增减，而不是单条数据的更新。

## 事务的隔离级别

- 读未提交（_read uncommitted_），指一个事务还没提交时，它做的变更就能被其他事务看到；
    
- 读提交（_read committed_），指一个事务提交之后，它做的变更才能被其他事务看到；
    
- 可重复读（_repeatable read_），指一个事务执行过程中看到的数据，一直跟这个事务启动时看到的数据是一致的，MySQL InnoDB 引擎的默认隔离级别；
    
- 串行化（_serializable_ ）；会对记录加上读写锁，在多个事务对这条记录进行读写操作时，如果发生了读写冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行；
    
<img src="/image/3.3.png" width = 100%>

## MVCC

InnoDB的MVCC，是通过在每行记录后面保存两个隐藏的列来实现的。这两个列，一个保存了行的创建时间，一个保存行的过期时间（或删除时间）。当然存储的并不是实际的时间值，而是系统版本号(system version number)。每开始一个新的事务，系统版本号都会自动递增。事务开始时刻的系统版本号会作为事务的版本号，用来和查询到的每行记录的版本号进行比较。

### ReadView

可以理解为数据库中某一个时刻所有未提交事务的快照。

<img src="/image/3.4.png" width = 100%>


### undo日志(索引记录的隐藏列)

<img src="/image/3.5.png" width = 100%>


### 事务访问记录时

一个事务去访问记录的时候，除了自己的更新记录总是可见之外，还有这几种情况：

- 如果记录的 trx_id 值小于 Read View 中的 `min_trx_id` 值，表示这个版本的记录是在创建 Read View 前已经提交的事务生成的，所以该版本的记录对当前事务可见。
    
- 如果记录的 trx_id 值大于等于 Read View 中的 `max_trx_id` 值，表示这个版本的记录是在创建 Read View 后才启动的事务生成的，所以该版本的记录对当前事务不可见。
    
- 如果记录的 trx_id 值在 Read View 的 `min_trx_id` 和 `max_trx_id` 之间，需要判断 trx_id 是否在 m_ids 列表中：
    
    - 如果记录的 trx_id 在 `m_ids` 列表中，表示生成该版本记录的活跃事务依然活跃着（还没提交事务），所以该版本的记录对当前事务不可见。
        
    - 如果记录的 trx_id 不在 `m_ids`列表中，表示生成该版本记录的活跃事务已经被提交，所以该版本的记录对当前事务可见。
        

这种通过「版本链」来控制并发事务访问同一个记录时的行为就叫 MVCC（多版本并发控制）。

### MVCC的作用

一句话：实现读已提交和可重复读

#### 可重复读

可重复读隔离级别是启动事务时生成一个 Read View，然后整个事务期间都在用这个 Read View。

### 读提交

读提交隔离级别是在每次读取数据时，都会生成一个新的 Read View。
